name: Deploy to Production

on:
  push:
    branches:
      - main

env:
  RUST_VERSION: '1.90.0'
  NODE_VERSION: '23.11.0'

jobs:
  # Backend Test Job
  backend-test:
    name: Backend - Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend

    services:
      postgres:
        image: postgis/postgis:16-3.4
        env:
          POSTGRES_USER: y_junction
          POSTGRES_PASSWORD: y_junction
          POSTGRES_DB: y_junction
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    env:
      DATABASE_URL: postgres://y_junction:y_junction@localhost:5432/y_junction

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          components: rustfmt, clippy

      - name: Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            backend/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('backend/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Install sqlx-cli
        run: cargo install sqlx-cli --no-default-features --features postgres,rustls

      - name: Run database migrations
        run: sqlx migrate run

      - name: Run tests
        run: cargo test --all-features

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Run Clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Security audit
        run: cargo audit || true

  # Frontend Test Job
  frontend-test:
    name: Frontend - Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Type check
        run: npm run typecheck

      - name: Lint
        run: npm run lint

      - name: Format check
        run: npm run format:check

  # Backend Deploy Job
  backend-deploy:
    name: Backend - Deploy
    runs-on: ubuntu-latest
    needs: [backend-test]

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Setup Rust for migrations
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Cache SQLx CLI
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/sqlx
          key: ${{ runner.os }}-sqlx-cli

      - name: Install SQLx CLI
        run: cargo install sqlx-cli --no-default-features --features postgres,rustls

      - name: Run database migrations
        working-directory: backend
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: sqlx migrate run

      - name: Authenticate Docker to Artifact Registry
        run: |
          gcloud auth configure-docker ${{ secrets.GCP_REGION }}-docker.pkg.dev

      - name: Build and push Docker image
        working-directory: backend
        run: |
          docker buildx build \
            --platform linux/amd64 \
            --push \
            --cache-from type=registry,ref=${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/y-junctions/backend:cache \
            --cache-to type=registry,ref=${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/y-junctions/backend:cache,mode=max \
            -t ${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/y-junctions/backend:${{ github.sha }} \
            -t ${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/y-junctions/backend:latest \
            .

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy y-junctions-api \
            --image ${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/y-junctions/backend:${{ github.sha }} \
            --region ${{ secrets.GCP_REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --no-service-account \
            --set-env-vars DATABASE_URL="${{ secrets.DATABASE_URL }}",RUST_LOG=info \
            --memory 512Mi \
            --cpu 1 \
            --min-instances 0 \
            --max-instances 10

      - name: Verify deployment
        run: |
          SERVICE_URL=$(gcloud run services describe y-junctions-api \
            --region ${{ secrets.GCP_REGION }} \
            --format 'value(status.url)')
          echo "Backend deployed to: $SERVICE_URL"

          # Health check
          for i in {1..5}; do
            if curl -f "$SERVICE_URL/health"; then
              echo "Health check passed"
              exit 0
            fi
            echo "Health check attempt $i failed, retrying..."
            sleep 10
          done
          echo "Health check failed after 5 attempts"
          exit 1

      - name: Rollback on failure
        if: failure()
        run: |
          echo "Deployment failed, checking for rollback..."
          PREVIOUS_REVISION=$(gcloud run revisions list \
            --service=y-junctions-api \
            --region=${{ secrets.GCP_REGION }} \
            --format="value(name)" \
            --sort-by=~createdTime \
            | sed -n '2p')

          if [ -n "$PREVIOUS_REVISION" ]; then
            echo "Rolling back to $PREVIOUS_REVISION"
            gcloud run services update-traffic y-junctions-api \
              --region=${{ secrets.GCP_REGION }} \
              --to-revisions=$PREVIOUS_REVISION=100
          fi

      - name: Cleanup old revisions
        if: success()
        run: |
          gcloud run revisions list \
            --service=y-junctions-api \
            --region=${{ secrets.GCP_REGION }} \
            --format="value(name)" \
            --sort-by=~createdTime \
            | tail -n +6 \
            | xargs -I {} gcloud run revisions delete {} \
              --region=${{ secrets.GCP_REGION }} \
              --quiet \
            || true

  # Frontend Deploy Job
  frontend-deploy:
    name: Frontend - Deploy
    runs-on: ubuntu-latest
    needs: [frontend-test]

    permissions:
      contents: read
      id-token: write

    defaults:
      run:
        working-directory: frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build
        env:
          VITE_API_URL: ${{ secrets.BACKEND_URL }}
        run: npm run build

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Deploy to Cloud Storage
        run: |
          gsutil -m rsync -r -d dist/ gs://${{ secrets.GCP_BUCKET_NAME }}

      - name: Verify deployment
        run: |
          echo "Frontend deployed to: https://storage.googleapis.com/${{ secrets.GCP_BUCKET_NAME }}/index.html"

  # Post-Deploy Job
  post-deploy:
    name: Post-Deploy Summary
    runs-on: ubuntu-latest
    needs: [backend-deploy, frontend-deploy]
    if: always()

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Generate deployment summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Backend status
          if [ "${{ needs.backend-deploy.result }}" == "success" ]; then
            BACKEND_URL=$(gcloud run services describe y-junctions-api \
              --region ${{ secrets.GCP_REGION }} \
              --format 'value(status.url)')
            echo "✅ **Backend**: Deployed successfully to $BACKEND_URL" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Backend**: Deployment failed" >> $GITHUB_STEP_SUMMARY
          fi

          # Frontend status
          if [ "${{ needs.frontend-deploy.result }}" == "success" ]; then
            echo "✅ **Frontend**: Deployed successfully to Cloud Storage" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Frontend**: Deployment failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY

      - name: Check overall status
        run: |
          if [ "${{ needs.backend-deploy.result }}" == "success" ] && [ "${{ needs.frontend-deploy.result }}" == "success" ]; then
            echo "✅ All deployments successful"
            exit 0
          else
            echo "❌ Some deployments failed"
            exit 1
          fi
